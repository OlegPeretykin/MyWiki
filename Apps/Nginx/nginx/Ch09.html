<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:exsl="http://exslt.org/common" xmlns:ng="http://docbook.org/docbook-ng" xmlns:fb="http://ogp.me/ns/fb#">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<link href="font-awesome.css" tppabs="https://netdna.bootstrapcdn.com/font-awesome/3.2.1/css/font-awesome.css" rel="stylesheet"/>
<title>Глава 9. Управление сложными потоками медиа - Книга рецептов NGINX</title>
<meta name="generator" content="DocBook XSL-NS Stylesheets V1.76.1"/>
<meta name="mavenGroupId" content="www.mdl.ru"/>
<meta name="NGINXCookbook"/>
<meta name="mavenVersionId" content="1.0.0"/>
<link rel="home" href="index.html" title="Книга рецептов NGINX"/>
<link rel="up" href="index.html" title="Книга рецептов NGINX"/>
<link rel="prev" href="Ch08.html" title="Глава 8. HTTP/2"/>
<link rel="next" href="Ch10.html" title="Глава 10. Развёртывание в облачных решениях"/>
<meta name="git-sha" content=""/>
<meta name="buildTime" content=""/>
<script type="text/javascript">
            //The id for tree cookie
            var treeCookieId = "nginx-cookbook";
            var language = "en";
            var w = new Object();
            //Localization
            txt_filesfound = 'Results';
            txt_enter_at_least_1_char = "You must enter at least one character.";
            txt_browser_not_supported = "Please enable JavaScript.";
            txt_please_wait = "Please wait. Search in progress...";
            txt_results_for = "Results for: ";
</script>
<style type="text/css">
            input {
            margin-bottom: 5px;
            margin-top: 2px;
            }

            .folder {
            display: block;
            height: 22px;
            padding-left: 20px;
            background: transparent url(folder.gif)/*tpa=http://onreader.mdl.ru/common/jquery/treeview/images/folder.gif*/ 0 0px no-repeat;
            }
</style>
<link rel="shortcut icon" href="MdlLogo.gif" tppabs="http://onreader.mdl.ru/MdlLogo.gif" type="image/gif"/>
<link rel="stylesheet" type="text/css" href="positioning.css" tppabs="http://onreader.mdl.ru/common/css/positioning.css"/>
<link rel="stylesheet" type="text/css" href="custom.css" tppabs="http://onreader.mdl.ru/common/css/custom.css"/>
<link rel="canonical" href="http://onreader.mdl.ru/NGINXCookbook/content/index.html"/>
<!--[if IE]>
	<link rel="stylesheet" type="text/css" href="ie.css" tppabs="http://onreader.mdl.ru/common/css/ie.css"/>
<![endif]-->
<link rel="stylesheet" type="text/css" href="jquery-ui-1.8.2.custom.css" tppabs="http://onreader.mdl.ru/common/jquery/theme-redmond/jquery-ui-1.8.2.custom.css"/>
<link rel="stylesheet" type="text/css" href="jquery.treeview.css" tppabs="http://onreader.mdl.ru/common/jquery/treeview/jquery.treeview.css"/>
<script type="text/javascript" src="jquery-1.11.0.min.js" tppabs="http://code.jquery.com/jquery-1.11.0.min.js"><!----></script>
<script type="text/javascript" src="jquery-ui-1.8.2.custom.min.js" tppabs="http://onreader.mdl.ru/common/jquery/jquery-ui-1.8.2.custom.min.js"><!----></script>
<script type="text/javascript" src="jquery.cookie.js" tppabs="http://onreader.mdl.ru/common/jquery/jquery.cookie.js"><!----></script>
<script type="text/javascript" src="jquery.treeview.min.js" tppabs="http://onreader.mdl.ru/common/jquery/treeview/jquery.treeview.min.js"><!----></script>
<link rel="stylesheet" type="text/css" href="jquery.qtip.min-1.css" tppabs="http://cdn.jsdelivr.net/qtip2/2.2.0/jquery.qtip.min.css"/>
<script type="text/javascript" src="jquery.qtip.min.js" tppabs="http://cdnjs.cloudflare.com/ajax/libs/qtip2/2.2.0/jquery.qtip.min.js">
<!--jQuery plugin for glossary popups. --></script>
<script type="text/javascript" src="htmlFileList.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/search/htmlFileList.js"><!----></script>
<script type="text/javascript" src="htmlFileInfoList.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/search/htmlFileInfoList.js"><!----></script>
<script type="text/javascript" src="nwSearchFnt.js" tppabs="http://onreader.mdl.ru/common/search/nwSearchFnt.js"><!----></script>
<script type="text/javascript" src="en_stemmer.js" tppabs="http://onreader.mdl.ru/common/search/stemmers/en_stemmer.js">
<!--//make this scalable to other languages as well.--></script>
<script type="text/javascript" src="index-1.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/search/index-1.js"><!----></script>
<script type="text/javascript" src="index-2.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/search/index-2.js"><!----></script>
<script type="text/javascript" src="index-3.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/search/index-3.js"><!----></script>
<script type="text/javascript">
	    var _gaq = _gaq || [];
	    _gaq.push(['_setAccount', 'UA-17511903-1']);
	    
	    _gaq.push(['_setDomainName', '.openstack.org']);	        
</script>
<script type="text/javascript" src="ga.js" tppabs="http://onreader.mdl.ru/common/ga.js"><!----></script>
<script language="javascript" src="common.js" tppabs="http://onreader.mdl.ru/js/common.js"></script>
<link rel="stylesheet" href="googlecode.css" tppabs="http://onreader.mdl.ru/common/css/googlecode.css">
<script src="highlight.pack.js" tppabs="http://onreader.mdl.ru/common/highlight.pack.js"></script>
</head>
<body>
<!----><script type="text/javascript"><!--
hljs.initHighlightingOnLoad();
HeaderName = 'Глава 9. Управление сложными потоками медиа';
PrevRef = 'Ch08.html'/*tpa=http://onreader.mdl.ru/NGINXCookbook/content/Ch08.html*/;
UpRef = 'index.html'/*tpa=http://onreader.mdl.ru/NGINXCookbook/content/index.html*/;
NextRef = 'Ch10.html'/*tpa=http://onreader.mdl.ru/NGINXCookbook/content/Ch10.html*/;//--></script>
<!----><script type="text/javascript" src="HeaderAndToolbar.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/HeaderAndToolbar.js">
</script><script type="text/javascript"><!--
document.write(HeaderAndToolbar); //-->
</script>
<div id="content">
 <div class="part">
  <div xmlns="" class="titlepage"><div><div><h1 xmlns="http://www.w3.org/1999/xhtml" class="title">
   Глава 9. Управление сложными потоками медиа
  </div></div></div>

  <div class="toc"><p><strong>Содержание</strong></p>
   <dl>
     <dt><span class="chapter"><a href="Ch09.html" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html">Глава 9. Управление сложными потоками медиа</a></span></dt>
     <dd><dl>
       <dt><span class="chapter"><a href="Ch09.html#01" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#01">Введение</a></span></dt>
       <dt><span class="chapter"><a href="Ch09.html#02" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#02">Обслуживание MP4 и FLV</a></span></dt>
       <dt><span class="chapter"><a href="Ch09.html#03" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#03">Организация потоков с помощью HLS</a></span></dt>
       <dt><span class="chapter"><a href="Ch09.html#04" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#04">Организация потоков с помощью HDS</a></span></dt>
       <dt><span class="chapter"><a href="Ch09.html#05" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#05">Пределы полосы пропускания</a></span></dt>
     </dl></dd>
   </dl>
  </div>

  <div class="section">
   <div xmlns="" class="titlepage"><div><div>
    <h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="01"> </a>Введение</h3>
   </div></div></div>
   <p>Данная глава рассматривает медиа потоки через NGINX в форматах MPEG-4 или Flash Video. NGINX широко применяется 
   для массивного распространения и потокового содержимого. NGINX поддерживает форматы стандартов отрасли и потоковые 
   технологии, которые будут обсуждены в данной главе. NGINX Plus делает возможным фрагментирование содержимого на лету 
   при помощи модуля HTTP Live Stream, а также возможность доставки HTTP Dynamic Streaming, который уже является 
   фрагментированным медиа. NGINX естественным образом допускает пределы для полос пропускания, а расширенные свойства 
   NGINX Plus предлагают пределы скорости передачи битов, что делает возможной доставку наиболее действенным способом 
   при резервировании имеющихся ресурсов сервера для охвата большего числа пользователей.</p>
  </div>

  <div class="section">
   <div xmlns="" class="titlepage"><div><div>
    <h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="02"> </a>Обслуживание MP4 и FLV</h3>
   </div></div></div>
   <p class="title"><strong>Задача</strong></p>
   <p>Вам требуется отправлять поток цифровых данных, изначально представленных в формате MPEG-4 (MP4) или Flash Video 
   (FLV).</p>
   <p class="title"><strong>Решение</strong></p>
   <p>Обозначьте некий блок местоположения HTTP как <span class="term"><code><em>.mp4</em></code></span> или 
   <span class="term"><code><em>.ﬂv</em></code></span>. NGINX будет управлять потоком этого медиа применяя прогрессивные 
   выгрузки или псевдопотоки HTTP с поддержкой поисков:</p>
	   <pre class="screen"><code>
http {
    server {
        ...

        location /videos/ {
            mp4;
        }
        location ~ \.flv$ {
            flv;
        }
    }
}
 	   </code></pre>
   <p>Блок местоположения данного примера сообщает что файлы в каталоге <span class="term"><code><em>videos</em></code></span> 
   представлены в формате с типом MP4 и могут направляться потоком с поддержкой прогрессивной выгрузки. Второй блок местоположения 
   указывает NGINX что все файлы, завершающиеся на <span class="term"><code><em>.ﬂv</em></code></span> представлены в 
   формате FLV и могут направляться потоком с поддержкой псевдопотоков HTTP.</p>
   <p class="title"><strong>Обсуждение</strong></p>
   <p>Потоковые видео и аудио файлы в NGINX являются неким образцом отдельной директивы. Прогрессивная выгрузка делает 
   возможным для клиента инициировать воспроизведение такого медиа до того как завершится выгрузка всего файла. NGINX 
   поддерживает операции поиска по неким пока не выгруженным порциям этого медиа в обоих фоматах.</p>
  </div>

  <div class="section">
   <div xmlns="" class="titlepage"><div><div>
    <h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="03"> </a>Организация потоков с помощью HLS</h3>
   </div></div></div>
   <p class="title"><strong>Задача</strong></p>
   <p>Вам требуется поддержка HTTP Live Streaming (HLS) для кодированного H.264/AAC содержимого, упакованного в файлы 
   MP4.</p>
   <p class="title"><strong>Решение</strong></p>
   <p>Воспользуйтесь модулем HLS NGINX Plus с сегментацией в реальном масштабе времени, пакетизацией и мультиплексированием, 
   а также с контролем буферизации фрагментов и многими иным в качестве аргументов перенаправления HLS:</p>
	   <pre class="screen"><code>
location /hls/ {
    hls; # Use the HLS handler to manage requests

    # Serve content from the following location
    alias /var/www/video;

    # HLS parameters
    hls_fragment 4s;
    hls_buffers 10 10m;
    hls_mp4_buffer_size 1m;
    hls_mp4_max_buffer_size 5m;
}
 	   </code></pre>
   <p>Данный блок местоположения демонстрирует направления NGINX для потоков медиа HLS из каталога 
   <span class="term"><code><em>/var/www/video</em></code></span>, причём с фрагментированием данного медиа на 
   сегменты по четыре секунды. Общее число буферов HLS устанавливается в 10 с размером по 10 Мегабайт. Начальный 
   размер буфера MP4 устанавливается в 1 МБ с максимальным значением в 5 МБ.</p>
   <p class="title"><strong>Обсуждение</strong></p>
   <p>Доступный в NGINX Plus модуль HLS предоставляет свои возможности для мультиплексирования транспортировки файлов с 
   медиа MP4 на лету. Существует множество директив, которые предоставляют вам возможность контроля над тем как фрагментируется 
   и буферизуется ваше медиа. Определённый блок местоположения должен быть настроен для обслуживания этого медиа как некого 
   потока HLS с соответствующим обработчиком HLS. Значение фрагментации HLS устанавливается в числе секунд, что указывает NGINX 
   на необходимость фрагментирования по длине времени. Общее число буферируемых данных устанавливается с помощью директивы 
   <span class="term"><code>hls_buffers</code></span>, определяющей количество буферов и их размер. Данному клиенту разрешается 
   начинать воспроизведение его медиа после осуществления накопления буферизации определённого объёма, определяемого 
   <span class="term"><code>hls_mp4_buffer_size</code></span>. Однако может потребоваться больший размер буфера если метаданные 
   для этого видео могут превышать первоначальный размер буфера. Такой объём блокируется сверху значением 
   <span class="term"><code>hls_mp4_max_buffer_size</code></span>. Эти переменные буферизации позволяют NGINX оптимизировать 
   практику получаемую конечным пользователем; выбор правильных значений для этих директив требует знания целевой аудитории и 
   вашего медиа. Например, если имеющиеся пачки вашего медиа составляют видео файлы, а ваша целевая аудитория имеет широкую 
   полосу пропускания, вы можете выполнить оптимизацию большим размером максимума буфера и фрагментированием с большей 
   длиной. Это позволит вам изначально выгружать без ошибок метаданные относительно содержимого, а вашим пользователям 
   получать фрагменты с большей длиной.</p>
  </div>

  <div class="section">
   <div xmlns="" class="titlepage"><div><div>
    <h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="04"> </a>Организация потоков с помощью HDS</h3>
   </div></div></div>
   <p class="title"><strong>Задача</strong></p>
   <p>Вам требуется поддержка HDS (HTTP Dynamic Streaming) Adobe, который уже был фрагментирован и обособлен от своих 
   метаданных.</p>
   <p class="title"><strong>Решение</strong></p>
   <p>Для предложения своим пользователям Adobe Adaptive Streaming воспользуйтесь модулем поддержки файлов FLV 
   (<span class="term"><code>F4F</code></span>) из NGINX Plus:</p>
	   <pre class="screen"><code>
location /video/ {
    alias /var/www/transformed_video;
    f4f;
    f4f_buffer_size 512k;
}
 	   </code></pre>
   <p>Данный пример указывает NGINX Plus на необходимость обслуживать изначально фрагментированное видео из некого 
   местоположения на диске своему клиенту при помощи модуля <span class="term"><code>F4F</code></span> NGINX Plus. 
   Значение размера буфера для его индексного файла (<span class="term"><code><em>.f4x</em></code></span>) устанавливается 
   в 512 килобайт.</p>
   <p class="title"><strong>Обсуждение</strong></p>
   <p>Модуль  <span class="term"><code>F4F</code></span> NGINX Plus позволяет NGINX обслуживать для конечных пользователей 
   изначально фрагментированные медиа. Сама настройка этого проста и состоит в применении обработчика 
   <span class="term"><code>F4F</code></span> внутри некого блока местоположения HTTP. Значение директивы 
   <span class="term"><code>f4f_buffer_size</code></span> настраивает величину размера буфера для файла индексации данного 
   типа медиа.</p>
  </div>

  <div class="section">
   <div xmlns="" class="titlepage"><div><div>
    <h3 xmlns="http://www.w3.org/1999/xhtml" class="title"><a id="05"> </a>Пределы полосы пропускания</h3>
   </div></div></div>
   <p class="title"><strong>Задача</strong></p>
   <p>Вам требуется лимитировать полосу пропускания нисходящего медиа потока клиентов без воздействия на практику 
   их просмотра.</p>
   <p class="title"><strong>Решение</strong></p>
   <p>Примените поддержку побитовой скорости NGINX Plus для файлов медиа MP4:</p>
	   <pre class="screen"><code>
location /video/ {
    mp4;
    mp4_limit_rate_after 15s;
    mp4_limit_rate 1.2;
}
 	   </code></pre>
   <p>Данная настройка позволяет клиентам вашего нисходящего потока выгружать 15 секунд до применения ограничения битовой 
   скорости. После 15 секунд данному клиенту разрешается выгружать медиа с соотношением 120% к установленной скорости обмена данных, 
   что делает возможным этому клиенту всегда выполнять выгрузку быстрее воспроизведения.</p>
   <p class="title"><strong>Обсуждение</strong></p>
   <p>Ограничение скорости обмена NGINX Plus позволяет вашему потоковому серверу динамично ограничивать полосу пропускания для 
   всего подлежащего обслуживанию медиа, позволяя клиентам выгрузку даже быстрее чем им это требуется чтобы обеспечить некую 
   бесшовную практику пользователям. Обсуждаемый обработчик MP4, описанный в рецепте <a class="link" href="Ch09.html#02" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/Ch09.html#02" 
   target="_top">Обслуживание MP4 и FLV</a>, озаглавливает этот блок местоположения для форматов MP4 медиа. Ограничивающие скорость 
   директивы, такие как <span class="term"><code>mp4_limit_rate_after</code></span>, указывают NGINX ограничивать в секундах 
   в скорости обмен только по прошествию установленного промежутка времени. Другой директивой, вовлечённой в ограничение 
   скорости  MP4 является <span class="term"><code>mp4_limit_rate</code></span>, которая определяет значение скорости обмена 
   данными для данного медиа. Значение 1 предоставляемое для директивы <span class="term"><code>mp4_limit_rate</code></span> 
   означает что NGINX ограничивает полосу пропускания скоростью воспроизведения этого медиа (1-к-1). Предоставление для данной 
   директивы значения <span class="term"><code>mp4_limit_rate</code></span> большего единицы позволит пользователям выполнять 
   выгрузку быстрее чем они просматривают с тем, чтобы они были способны осуществлять буферизацию своего медиа и бесшовно 
   просматривать его в процессе его выгрузки.</p>
  </div>
 </div>

<!----><script type="text/javascript" src="FooterAndSidebar.js" tppabs="http://onreader.mdl.ru/NGINXCookbook/content/FooterAndSidebar.js">
</script><script type="text/javascript"><!--</div id="content"> is inside next code
document.write(FooterAndSidebar);//-->
</script>

</body></html>
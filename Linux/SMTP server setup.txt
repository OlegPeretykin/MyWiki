Настройка почтового клиента для отсылки уведомлений
Ну какой современный мониторинг без уведомлений? Правильно - никакой. Поэтому подготовим наш сервер к тому, чтобы он мог отсылать нам сообщения на электронную почту. Данная настройка выполняется на мастере, вместо того чтобы поднимать здесь почтовый сервер, мы установим почтовый клиент, который прозрачно заменит sendmail и позволит работать с внешней почтовой службой, публичной или собственной.

apt install ssmtp mailutils
Затем откроем /etc/ssmtp/ssmtp.conf и добавим учетную запись почты:

mailhub=mail.it-31.ru:587

  AuthUser=munin@it-31.ru
  AuthPass=Pa$$word_1
  UseTLS=YES
  UseSTARTTLS=YES
  TLS_CA_File=/etc/pki/tls/certs/ca-bundle.crt
Каждая учетная запись начинается с опции mailhub, где указывается почтовый сервер и порт подключения клиента. Ниже указываем учетные данные и параметры шифрования, а также путь к собственному сертификату.

Ниже находим и приводим к следующему виду опцию:

FromLineOverride=YES
Сохраняем файл и открываем следующий /etc/ssmtp/revaliases, в него добавляем строку:

munin:munin@it-31.ru:mail.it-31.ru:587
Которая обозначает, что пользователь munin должен использовать учетную запись munin@it-31.ru на сервере mail.it-31.ru:587.

Проверяем отправку почты:

echo "Test" | su - munin --shell=/bin/bash -c "mail  -s "Test" andrey@it-31.ru"
В данном случае мы отправляем письмо с темой Test и сообщением Тest на ящик andrey@it-31.ru.

Если письмо доставлено нормально, то все хорошо, иначе выполняем отладку командой:

echo "Test" | su - munin --shell=/bin/bash -c "ssmtp -v -s "Test" andrey@it-31.ru"
В этом случае на экран будет выведен лог почтовой сессии, что в большинстве случаев достаточно для выявления и устранения проблемы.
